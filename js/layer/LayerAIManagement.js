var floatingWindows=[];function openT2I_FloatingWindowItem(layer){var floatingWindowItem=document.createElement("div");floatingWindowItem.className="floating-windowPromptClass";floatingWindowItem.style.cursor="move";floatingWindowItem.innerHTML=`\n    <h4>${layer.name} Settings</h4>\n    <div class="form-group">\n      <label for="text2img_prompt">Prompt:</label>\n      <textarea id="text2img_prompt" rows="3">${layer.text2img_prompt||""}</textarea>\n    </div>\n    <div class="form-group">\n      <label for="text2img_negativePrompt">Negative Prompt:</label>\n      <textarea id="text2img_negativePrompt" rows="3">${layer.text2img_negativePrompt||""}</textarea>\n    </div>\n    <div class="form-group form-row">\n      <label for="text2img_seed">Seed(-1=Rundom, -2=Use Base):</label>\n      <input type="number" id="text2img_seed" value="${layer.text2img_seed||-2}">\n    </div>\n    <div class="form-group form-row">\n      <label for="text2img_width">Width(-1=Use Base):</label>\n      <input type="number" id="text2img_width" step="8"  min="0" value="${layer.text2img_width||1024}">\n    </div>\n    <div class="form-group form-row">\n      <label for="text2img_height">Height(-1=Use Base):</label>\n      <input type="number" id="text2img_height" step="8"  min="0" value="${layer.text2img_height||1024}">\n    </div>\n\n    <div class="button-group">\n      <button id="text2imgItem_saveButton">Save</button>\n      <button id="text2imgItem_closeButton">Close</button>\n    </div>\n  `;document.body.appendChild(floatingWindowItem);document.getElementById("text2img_height").addEventListener("blur",(function(){var value=parseInt(this.value);if(value!==-1){this.value=Math.round(value/8)*8}}));document.getElementById("text2img_width").addEventListener("blur",(function(){var value=parseInt(this.value);if(value!==-1){this.value=Math.round(value/8)*8}}));makeDraggable(floatingWindowItem);updatefloatingWindowItem(layer,floatingWindowItem);var saveButton=floatingWindowItem.querySelector("#text2imgItem_saveButton");saveButton.onclick=function(){adjustToMultipleOfEight("text2img_height");adjustToMultipleOfEight("text2img_width");saveLayerDiffusionAttributes(layer);closefloatingWindowItem(floatingWindowItem)};var closeButton=floatingWindowItem.querySelector("#text2imgItem_closeButton");closeButton.onclick=function(){closefloatingWindowItem(floatingWindowItem)};floatingWindows.push(floatingWindowItem)}function openI2I_floatingWindowItem(layer){var floatingWindowItem=document.createElement("div");floatingWindowItem.className="floating-windowPromptClass";floatingWindowItem.style.cursor="move";floatingWindowItem.innerHTML=`\n    <h4>${layer.name} Settings</h4>\n    <div class="form-group">\n      <label for="text2img_prompt">Prompt:</label>\n      <textarea id="text2img_prompt" rows="3">${layer.text2img_prompt||""}</textarea>\n    </div>\n    <div class="form-group">\n      <label for="text2img_negativePrompt">Negative Prompt:</label>\n      <textarea id="text2img_negativePrompt" rows="3">${layer.text2img_negativePrompt||""}</textarea>\n    </div>\n    <div class="form-group form-row">\n      <label for="text2img_seed">Seed(-1=Rundom, -2=Use Base):</label>\n      <input type="number" id="text2img_seed" value="${layer.text2img_seed||-2}">\n    </div>\n    \n    <div class="form-group form-row">\n      <label for="img2imgScale">Scale:</label>\n      <input type="number" id="img2imgScale" step="0.1"  min="0.1" value="${layer.img2imgScale||1.2}">\n    </div>\n    \n    <div class="form-group form-row">\n      <label for="img2img_denoising_strength">Denoising Strength:</label>\n      <input type="number" id="img2img_denoising_strength" step="0.01"  max="1" min="0" value="${layer.img2img_denoising_strength||.7}">\n    </div>\n    <div class="button-group">\n      <button id="text2imgItem_saveButton">Save</button>\n      <button id="text2imgItem_closeButton">Close</button>\n    </div>\n  `;document.body.appendChild(floatingWindowItem);makeDraggable(floatingWindowItem);updatefloatingWindowItem(layer,floatingWindowItem);var saveButton=floatingWindowItem.querySelector("#text2imgItem_saveButton");saveButton.onclick=function(){saveLayerDiffusionAttributes(layer);closefloatingWindowItem(floatingWindowItem)};var closeButton=floatingWindowItem.querySelector("#text2imgItem_closeButton");closeButton.onclick=function(){closefloatingWindowItem(floatingWindowItem)};floatingWindows.push(floatingWindowItem)}function adjustToMultipleOfEight(elementId){var inputElement=document.getElementById(elementId);var value=parseInt(inputElement.value);if(value!==-1){inputElement.value=Math.round(value/8)*8}}function updatefloatingWindowItem(layer,floatingWindowItem){floatingWindowItem.style.left=50+"px";floatingWindowItem.style.top=50+"px";floatingWindowItem.style.width="45%";console.log("updatefloatingWindowItem left top",floatingWindowItem.style.left,floatingWindowItem.style.top)}function saveLayerDiffusionAttributes(layer){layer.text2img_prompt=document.getElementById("text2img_prompt").value;layer.text2img_negativePrompt=document.getElementById("text2img_negativePrompt").value;layer.text2img_seed=parseInt(document.getElementById("text2img_seed").value);if(isImage(layer)){layer.img2imgScale=parseFloat(document.getElementById("img2imgScale").value)}else{layer.text2img_width=parseInt(document.getElementById("text2img_width").value);layer.text2img_height=parseInt(document.getElementById("text2img_height").value)}if(isImage(layer)){layer.img2img_denoising_strength=parseFloat(document.getElementById("img2img_denoising_strength").value)}saveState()}function closefloatingWindowItem(floatingWindowItem){if(floatingWindowItem){document.body.removeChild(floatingWindowItem);const index=floatingWindows.indexOf(floatingWindowItem);if(index>-1){floatingWindows.splice(index,1)}}}function openText2ImageBaseFloatingWindow(){const floatingWindow=document.createElement("div");floatingWindow.className="floating-windowPromptClass";floatingWindow.style.cursor="move";floatingWindow.innerHTML=`\n        <h4>Text2Image Base Settings</h4>\n        <div class="form-group">\n            <label>Prompt:</label>\n            <textarea id="text2img_basePrompt_prompt" rows="3">${text2img_basePrompt.text2img_prompt}</textarea>\n        </div>\n        <div class="form-group">\n            <label>Negative Prompt:</label>\n            <textarea id="text2img_basePrompt_negativePrompt" rows="3">${text2img_basePrompt.text2img_negativePrompt}</textarea>\n        </div>\n        \n        <hr>\n\n        <div class="form-group form-row">\n            <label>Seed:</label>\n            <input type="number" id="text2img_basePrompt_seed"  min="-2" value="${text2img_basePrompt.text2img_seed}">\n        </div>\n        <div class="form-group form-row">\n            <label>CFG Scale:</label>\n            <input type="number" id="text2img_basePrompt_cfg_scale" min="1" value="${text2img_basePrompt.text2img_cfg_scale}">\n        </div>\n        <div class="form-group form-row">\n            <label>Width:</label>\n            <input type="number" id="text2img_basePrompt_width" step="8" min="0" value="${text2img_basePrompt.text2img_width}">\n        </div>\n        <div class="form-group form-row">\n            <label>Height:</label>\n            <input type="number" id="text2img_basePrompt_height" step="8"  min="0" value="${text2img_basePrompt.text2img_height}">\n        </div>\n        <div class="form-group form-row">\n            <label>Sampling Method:</label>\n            <select id="text2img_basePrompt_samplingMethod"></select>\n        </div>\n        <div class="form-group form-row">\n            <label>Sampling Steps:</label>\n            <input type="number" id="text2img_basePrompt_samplingSteps" value="${text2img_basePrompt.text2img_samplingSteps}">\n        </div>\n        <div class="form-group form-row">\n          <label>Model:</label>\n          <select id="text2img_basePrompt_model"></select>\n        </div>\n\n        <hr>\n\n        <h7>Hires. fix</h7>\n        <div class="form-group form-row">\n            <label>Upscaler:</label>\n            <select id="text2img_basePrompt_hr_upscaler"></select>\n        </div>\n\n        <div class="form-group form-row">\n          <label>Scale:</label>\n          <input type="number" id="text2img_basePrompt_hr_scale" step="0.1"  min="1.0" max="4" value="${text2img_basePrompt.text2img_basePrompt_hr_scale}">\n        </div>\n        <div class="form-group form-row">\n          <label>Denoising Strength:</label>\n          <input type="number" id="text2img_basePrompt_hr_denoising_strength" step="0.01" min="0" max="1.0" value="${text2img_basePrompt.text2img_basePrompt_hr_denoising_strength}">\n        </div>\n        <div class="form-group form-row">\n          <label>Step:</label>\n          <input type="number" id="text2img_basePrompt_hr_step" step="1" min="1" max="150" value="${text2img_basePrompt.text2img_basePrompt_hr_step}">\n        </div>\n\n        <button id="baseSaveButton">Save</button>\n        <button id="baseCloseButton">Close</button>\n    `;document.body.appendChild(floatingWindow);document.getElementById("text2img_basePrompt_height").addEventListener("blur",(function(){var value=parseInt(this.value);if(value!==-1){this.value=Math.round(value/8)*8}}));document.getElementById("text2img_basePrompt_width").addEventListener("blur",(function(){var value=parseInt(this.value);if(value!==-1){this.value=Math.round(value/8)*8}}));makeDraggable(floatingWindow);if(API_mode==apis.A1111){fetchSD_Models();fetchSD_Sampler();fetchSD_Upscaler()}else if(API_mode==apis.COMFYUI){comufyModels();comufySampler();comufyUpscaler()}var baseSaveButton=floatingWindow.querySelector("#baseSaveButton");baseSaveButton.onclick=function(){updateText2ImgBasePrompt(floatingWindow)};var baseCloseButton=floatingWindow.querySelector("#baseCloseButton");baseCloseButton.onclick=function(){closefloatingWindowItem(floatingWindow)}}function updateText2ImgBasePrompt(floatingWindow){adjustToMultipleOfEight("text2img_basePrompt_width");adjustToMultipleOfEight("text2img_basePrompt_height");text2img_basePrompt.text2img_prompt=document.getElementById("text2img_basePrompt_prompt").value;text2img_basePrompt.text2img_negativePrompt=document.getElementById("text2img_basePrompt_negativePrompt").value;text2img_basePrompt.text2img_seed=parseInt(document.getElementById("text2img_basePrompt_seed").value,10);text2img_basePrompt.text2img_cfg_scale=parseInt(document.getElementById("text2img_basePrompt_cfg_scale").value,10);text2img_basePrompt.text2img_width=parseInt(document.getElementById("text2img_basePrompt_width").value,10);text2img_basePrompt.text2img_height=parseInt(document.getElementById("text2img_basePrompt_height").value,10);text2img_basePrompt.text2img_samplingSteps=parseInt(document.getElementById("text2img_basePrompt_samplingSteps").value,10);text2img_basePrompt.text2img_hr_upscaler=document.getElementById("text2img_basePrompt_hr_upscaler").value;text2img_basePrompt.text2img_basePrompt_hr_scale=document.getElementById("text2img_basePrompt_hr_scale").value;text2img_basePrompt.text2img_basePrompt_hr_denoising_strength=document.getElementById("text2img_basePrompt_hr_denoising_strength").value;text2img_basePrompt.text2img_basePrompt_hr_step=document.getElementById("text2img_basePrompt_hr_step").value;var selectedModel=document.getElementById("text2img_basePrompt_model").value;text2img_basePrompt.text2img_model=selectedModel;var selectedSampler=document.getElementById("text2img_basePrompt_samplingMethod").value;text2img_basePrompt.text2img_samplingMethod=selectedSampler;console.log("Updated selectedModel:",selectedModel);closefloatingWindowItem(floatingWindow);if(API_mode==apis.A1111)sendModelToServer()}