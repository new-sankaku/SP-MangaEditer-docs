<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Fabric.js Mask Tool</title><script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script><style>body{display:flex;flex-direction:column;align-items:center}canvas{border:1px solid #ccc}.buttons{margin-top:10px}</style></head><body><canvas id="canvas" width="800" height="600"></canvas><div class="buttons"><input type="file" id="file-input" accept="image/*"> <button id="clear-mask">マスクを削除</button> <button id="download-mask">マスクをダウンロード</button></div><script>const canvas=new fabric.Canvas("canvas");let currentPath,isDrawing=!1;function log(t){console.log(`[LOG] ${(new Date).toISOString()} - ${t}`)}function maskPath(t){log("重複するマスクの確認を開始します");canvas.getObjects().forEach((e=>{e!==t&&"path"===e.type&&""!==e.fill&&isPathOverlapping(t,e)&&(canvas.remove(e),log("重複するマスクが削除されました"))})),t.set({fill:"rgba(255, 0, 0, 0.6)",stroke:"",strokeDashArray:null}),canvas.renderAll(),log("新しいマスクが適用されました")}function isPathOverlapping(t,e){const n=t.getBoundingRect(),a=e.getBoundingRect(),o=!(n.left>a.left+a.width||n.left+n.width<a.left||n.top>a.top+a.height||n.top+n.height<a.top);return log(`パスの重複確認: ${o}`),o}document.getElementById("file-input").addEventListener("change",(function(t){log("画像ファイルが選択されました");const e=new FileReader;e.onload=function(t){const e=new Image;e.src=t.target.result,e.onload=function(){const t=new fabric.Image(e);t.set({left:0,top:0,scaleX:canvas.width/t.width,scaleY:canvas.height/t.height}),canvas.setBackgroundImage(t,canvas.renderAll.bind(canvas)),log("背景画像が設定されました")}},e.readAsDataURL(t.target.files[0])})),canvas.on("mouse:down",(function(t){isDrawing=!0;const e=canvas.getPointer(t.e);currentPath=new fabric.Path(`M ${e.x} ${e.y}`,{fill:"",stroke:"yellow",strokeDashArray:[10,5],strokeWidth:3,selectable:!1}),canvas.add(currentPath),log(`マウスダウン - パス作成 - 座標: (${e.x}, ${e.y})`),log(`パスが追加されました: ${JSON.stringify(currentPath.toObject())}`)})),canvas.on("mouse:move",(function(t){if(!isDrawing)return;const e=canvas.getPointer(t.e);currentPath.path.push(["L",e.x,e.y]),currentPath.set({path:currentPath.path}),canvas.renderAll(),log(`マウス移動 - パス更新 - 座標: (${e.x}, ${e.y})`),log(`現在のパスデータ: ${JSON.stringify(currentPath.path)}`)})),canvas.on("mouse:up",(function(t){isDrawing&&(isDrawing=!1,log("マウスアップ - パスが確定しました"),log(`最終パスデータ: ${JSON.stringify(currentPath.path)}`),maskPath(currentPath))})),document.getElementById("clear-mask").addEventListener("click",(function(){log("マスクを削除ボタンがクリックされました"),canvas.getObjects().forEach((t=>{"path"===t.type&&""!==t.fill&&canvas.remove(t)})),canvas.renderAll(),log("全てのマスクが削除されました")})),document.getElementById("download-mask").addEventListener("click",(function(){log("マスクをダウンロードボタンがクリックされました");const t=document.createElement("a");t.href=canvas.toDataURL({format:"png",multiplier:1}),t.download="mask.png",t.click(),log("マスクがダウンロードされました")}))</script></body></html>