<!DOCTYPE html><html><head><meta charset="utf-8"><title>Mosaic Canvas with Centered Preview and Size Logging</title><script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script><style>#canvas-container{border:1px solid #ccc;margin:10px}#controls{margin:10px}.slider-container{margin:10px 0}</style></head><body><div id="controls"><button id="toggle-mosaic-brush">Enable Mosaic Brush</button> <input type="file" id="image-loader" name="image-loader"> <button id="download">Download Canvas</button> <button id="contextTopDownload">Download ContextTop</button><div class="slider-container"><label for="mosaic-size">Mosaic Size:</label> <input type="range" id="mosaic-size" min="1" max="300" value="10"> <span id="mosaic-size-value">10</span></div><div class="slider-container"><label for="circle-size">Circle Size:</label> <input type="range" id="circle-size" min="1" max="300" value="40"> <span id="circle-size-value">40</span></div></div><div id="canvas-container"><canvas id="c" width="800" height="600"></canvas></div><script>var canvas=new fabric.Canvas("c");canvas.setBackgroundColor("white",canvas.renderAll.bind(canvas)),fabric.MosaicBrush=fabric.util.createClass(fabric.BaseBrush,{initialize:function(a){this.canvas=a,this.mosaicSize=10,this.circleSize=40,this.isDrawing=!1,this.lastPointer={x:this.canvas.width/2,y:this.canvas.height/2}},onMouseDown:function(a){this.isDrawing=!0,this.lastPointer=a,this.canvas.contextTop.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawMosaic(a)},onMouseMove:function(a){this.lastPointer=a,this.isDrawing?this.drawMosaic(a):this.drawPreviewCircle(a)},onMouseUp:function(){this.isDrawing=!1,this.commitDrawing(),this.drawPreviewCircle(this.lastPointer)},drawMosaic:function(a){var e=this.canvas.contextTop,t=this.canvas.getContext("2d");console.log("ContextTop canvas size:",e.canvas.width,"x",e.canvas.height),console.log("ContextTop scale      :",e.getTransform().a,"x",e.getTransform().d),console.log("Main canvas size      :",t.canvas.width,"x",t.canvas.height),console.log("Main context scale    :",t.getTransform().a,"x",t.getTransform().d);for(var i=this.mosaicSize,n=this.circleSize/2,s=Math.floor(Math.max(0,a.x-n)/i),c=Math.floor(Math.max(0,a.y-n)/i),r=Math.ceil(Math.min(this.canvas.width,a.x+n)/i),o=Math.ceil(Math.min(this.canvas.height,a.y+n)/i),h=t.getTransform().a,l=t.getTransform().d,v=s;v<r;v++)for(var g=c;g<o;g++){var d=(v+.5)*i,u=(g+.5)*i;if(this.isInsideCircle(a.x,a.y,d,u,n)){var w=v*i,m=g*i,f=t.getImageData(w*h,m*l,i*h,i*l);console.log("ImageData size:",f.width,"x",f.height),console.log("Total pixels:",f.width*f.height),console.log("Data array length:",f.data.length);for(var B=f.data,x=0,D=0,M=0,z=0,p=0,I=0;I<B.length;I+=4)x+=B[I],D+=B[I+1],M+=B[I+2],z+=B[I+3],p++;x=Math.floor(x/p),D=Math.floor(D/p),M=Math.floor(M/p),z=Math.floor(z/p),e.fillStyle=`rgba(${x},${D},${M},${z/255})`,e.fillRect(w,m,i,i)}}},commitDrawing:function(){var a=this.canvas.contextTop,e=1/a.getTransform().a,t=1/a.getTransform().d;console.log("commitDrawing ctx    :x:",e,"y:",t);var i=a.canvas.toDataURL();fabric.Image.fromURL(i,(i=>{i.set({left:0,top:0,selectable:!1,evented:!1,scaleX:e,scaleY:t}),this.canvas.add(i),this.canvas.renderAll(),a.clearRect(0,0,this.canvas.width,this.canvas.height)}))},isInsideCircle:function(a,e,t,i,n){var s=a-t,c=e-i;return s*s+c*c<=n*n},drawPreviewCircle:function(a){var e=this.canvas.contextTop;e.clearRect(0,0,this.canvas.width,this.canvas.height),e.beginPath(),e.arc(a.x,a.y,this.circleSize/2,0,2*Math.PI),e.strokeStyle="rgba(0, 255, 0, 0.5)",e.lineWidth=2,e.stroke(),e.strokeStyle="rgba(255, 0, 0, 0.3)",e.lineWidth=1;for(var t=Math.floor(a.x-this.circleSize/2),i=Math.floor(a.y-this.circleSize/2),n=t+this.circleSize,s=i+this.circleSize,c=t;c<=n;c+=this.mosaicSize)e.beginPath(),e.moveTo(c,i),e.lineTo(c,s),e.stroke();for(var r=i;r<=s;r+=this.mosaicSize)e.beginPath(),e.moveTo(t,r),e.lineTo(n,r),e.stroke()}});var mosaicBrush=new fabric.MosaicBrush(canvas),isMosaicBrushActive=!1;function updatePreview(){isMosaicBrushActive&&canvas.freeDrawingBrush&&canvas.freeDrawingBrush.drawPreviewCircle({x:canvas.width/2,y:canvas.height/2})}document.getElementById("toggle-mosaic-brush").addEventListener("click",(function(){isMosaicBrushActive?(canvas.isDrawingMode=!1,canvas.freeDrawingBrush=null,canvas.contextTop.clearRect(0,0,canvas.width,canvas.height),this.textContent="Enable Mosaic Brush"):(canvas.isDrawingMode=!0,canvas.freeDrawingBrush=mosaicBrush,canvas.freeDrawingBrush.mosaicSize=parseInt(document.getElementById("mosaic-size").value),canvas.freeDrawingBrush.circleSize=parseInt(document.getElementById("circle-size").value),this.textContent="Disable Mosaic Brush",canvas.freeDrawingBrush.drawPreviewCircle({x:canvas.width/2,y:canvas.height/2})),isMosaicBrushActive=!isMosaicBrushActive})),document.getElementById("mosaic-size").addEventListener("input",(function(){var a=this.value;document.getElementById("mosaic-size-value").textContent=a,canvas.freeDrawingBrush&&(canvas.freeDrawingBrush.mosaicSize=parseInt(a),updatePreview())})),document.getElementById("circle-size").addEventListener("input",(function(){var a=this.value;document.getElementById("circle-size-value").textContent=a,canvas.freeDrawingBrush&&(canvas.freeDrawingBrush.circleSize=parseInt(a),updatePreview())})),canvas.on("mouse:move",(function(a){isMosaicBrushActive&&canvas.freeDrawingBrush&&!canvas.freeDrawingBrush.isDrawing&&canvas.freeDrawingBrush.drawPreviewCircle(canvas.getPointer(a.e))})),document.getElementById("image-loader").addEventListener("change",(function(a){var e=new FileReader;e.onload=function(a){var e=new Image;e.src=a.target.result,e.onload=function(){var a=new fabric.Image(e);canvas.setBackgroundImage(a,canvas.renderAll.bind(canvas),{scaleX:canvas.width/a.width,scaleY:canvas.height/a.height}),console.log("Canvas size:",canvas.width,"x",canvas.height),console.log("Image size:",a.width,"x",a.height),console.log("Scale:",canvas.width/a.width,"x",canvas.height/a.height)}},e.readAsDataURL(a.target.files[0])})),document.getElementById("download").addEventListener("click",(function(){var a=canvas.width,e=canvas.height;canvas.setWidth(3*a),canvas.setHeight(3*e),canvas.setZoom(3);var t=Date.now(),i=canvas.toDataURL({format:"png"}),n=document.createElement("a");n.href=i,n.download="canvas_high_res.png",n.click();var s=Date.now();console.log("Download process took "+(s-t)+"ms"),canvas.setWidth(a),canvas.setHeight(e),canvas.setZoom(1),canvas.renderAll()})),document.getElementById("contextTopDownload").addEventListener("click",(function(){var a=canvas.contextTop.canvas.toDataURL("image/png"),e=document.createElement("a");e.href=a,e.download="contextTop.png",e.click()})),console.log("Initial canvas size:",canvas.width,"x",canvas.height)</script></body></html>