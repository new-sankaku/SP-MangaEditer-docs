<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Fabric.js 複雑な形状のポリゴンクロップ</title><script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script><style>body{font-family:Arial,sans-serif;text-align:center}#canvas{border:1px solid #ccc;margin:20px auto}#message{color:red;margin-top:10px}button{margin:5px}</style></head><body><h1>Fabric.js 複雑な形状のポリゴンクロップ</h1><canvas id="canvas" width="800" height="600"></canvas><br><input type="file" id="imageUpload" accept="image/*"> <button id="addPointButton">ポイント追加</button> <button id="cropButton" disabled="disabled">クロップしてダウンロード</button><div id="message"></div><script>const canvas=new fabric.Canvas("canvas");let polygon;function initPolygon(){polygon=new fabric.Polygon([{x:100,y:100},{x:200,y:50},{x:300,y:100},{x:250,y:200},{x:150,y:200}],{fill:"rgba(0,0,0,0.2)",stroke:"black",strokeWidth:2,selectable:!1,evented:!1}),canvas.add(polygon),addControlPoints()}function addControlPoints(){polygon.points.forEach(((n,t)=>{const e=new fabric.Circle({left:n.x,top:n.y,radius:5,fill:"red",originX:"center",originY:"center",hasBorders:!1,hasControls:!1,pointIndex:t});e.on("moving",(function(){polygon.points[this.pointIndex]={x:this.left,y:this.top},polygon.setCoords(),canvas.renderAll()})),canvas.add(e)}))}function addPoint(){const n=polygon.get("points"),t=n[n.length-1],e={x:t.x+50,y:t.y+50};n.push(e),polygon.set({points:n});const o=new fabric.Circle({left:e.x,top:e.y,radius:5,fill:"red",originX:"center",originY:"center",hasBorders:!1,hasControls:!1,pointIndex:n.length-1});o.on("moving",(function(){polygon.points[this.pointIndex]={x:this.left,y:this.top},polygon.setCoords(),canvas.renderAll()})),canvas.add(o),canvas.renderAll()}document.getElementById("imageUpload").addEventListener("change",(function(n){const t=n.target.files[0];if(t){const n=new FileReader;n.onload=function(n){fabric.Image.fromURL(n.target.result,(function(n){canvas.clear(),canvas.setWidth(n.width),canvas.setHeight(n.height),canvas.setBackgroundImage(n,canvas.renderAll.bind(canvas)),initPolygon(),document.getElementById("cropButton").disabled=!1}))},n.readAsDataURL(t)}})),document.getElementById("addPointButton").addEventListener("click",addPoint),document.getElementById("cropButton").addEventListener("click",(function(){try{canvas.getContext("2d");const n=polygon.points.map((n=>({x:n.x,y:n.y}))),t=document.createElement("canvas");t.width=canvas.width,t.height=canvas.height;const e=t.getContext("2d");e.beginPath(),n.forEach(((n,t)=>{0===t?e.moveTo(n.x,n.y):e.lineTo(n.x,n.y)})),e.closePath(),e.clip(),e.drawImage(canvas.getElement(),0,0);const o=Math.min(...n.map((n=>n.x))),a=Math.min(...n.map((n=>n.y))),i=Math.max(...n.map((n=>n.x))),c=Math.max(...n.map((n=>n.y))),s=document.createElement("canvas");s.width=i-o,s.height=c-a;s.getContext("2d").drawImage(t,o,a,i-o,c-a,0,0,i-o,c-a);const d=s.toDataURL("image/png"),l=document.createElement("a");l.download="cropped-image.png",l.href=d,l.click(),document.getElementById("message").textContent="クロップ成功！画像がダウンロードされました。"}catch(n){document.getElementById("message").textContent="クロップ中にエラーが発生しました: "+n.message}})),initPolygon()</script></body></html>