<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><style>body{margin:0;display:flex;flex-direction:column;align-items:center;padding-top:20px;background:#f0f0f0}#c{border:1px solid #000;margin-bottom:10px}#m,#st{display:flex;gap:5px;margin-bottom:10px;align-items:center}.a{background:#4caf50;color:#fff}#sr,#st>div{display:flex;align-items:center;gap:10px}</style></head><body><canvas id="c" width="600" height="400"></canvas><div id="m"><button id="aa">座標</button><button id="bb">自由</button><button id="dd">移動</button><button id="ff">追加</button><button id="gg">削除</button><button id="ee">消去</button></div><div id="st"><div><label for="fc">塗色:</label><input type="color" id="fc" value="#FFFFFF"></div><div><label for="sc">線色:</label><input type="color" id="sc" value="#000000"></div><div><label for="sw">線幅:</label><input type="number" id="sw" min="1" max="20" value="2"></div><div><label for="fa">透明:</label><input type="range" id="fa" min="0" max="100" value="100"><span id="fav">100</span></div></div><div id="sr"><label for="sm">滑:</label><input type="range" id="sm" min="0" max="100" value="50"><span id="sv">50</span></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jsts/2.9.3/jsts.min.js"></script><script>const c=document.getElementById("c"),x=c.getContext("2d"),a=document.getElementById("aa"),b=document.getElementById("bb"),d=document.getElementById("dd"),f=document.getElementById("ff"),g=document.getElementById("gg"),e=document.getElementById("ee"),m=document.getElementById("sm"),v=document.getElementById("sv"),h=document.getElementById("fc"),i=document.getElementById("sc"),j=document.getElementById("sw"),k=document.getElementById("fa"),l=document.getElementById("fav"),t=30,n=new jsts.geom.GeometryFactory(new jsts.geom.PrecisionModel(1e6));let o="point",p=[],q=null,r=[],s=!1,u=[],w=-1,y=[],z=-1;function A(e){[a,b,d,f,g].forEach((e=>e.classList.remove("a"))),e.classList.add("a")}function D(e,t=!1,n=null){x.beginPath();e.getCoordinates().forEach(((e,t)=>{0===t?x.moveTo(e.x,e.y):x.lineTo(e.x,e.y)})),x.closePath(),t?(x.fillStyle="rgba(0,0,255,0.2)",x.strokeStyle="blue",x.lineWidth=parseInt(j.value)):(x.fillStyle=n?n.fillColor:"white",x.strokeStyle=n?n.strokeColor:i.value,x.lineWidth=n?n.strokeWidth:parseInt(j.value)),x.fill(),x.stroke(),t||n||(x.fillStyle=`${h.value}${Math.round(2.55*k.value).toString(16).padStart(2,"0")}`,x.fill())}function K(){x.clearRect(0,0,c.width,c.height),r.forEach(((e,t)=>{t===w&&["edit","add","delete"].includes(o)?D(L(y),!0):D(e,!1,e.style)})),["edit","add","delete"].includes(o)&&-1!==w&&y.forEach(((e,t)=>{x.beginPath(),x.arc(e.x,e.y,5,0,2*Math.PI),x.fillStyle=t===z?"red":"blue",x.fill()})),"point"===o&&p.length>0?(x.beginPath(),x.moveTo(p[0].x,p[0].y),p.forEach((e=>x.lineTo(e.x,e.y))),q&&x.lineTo(q.x,q.y),x.fillStyle="rgba(0,0,255,0.2)",x.fill(),x.strokeStyle="blue",x.lineWidth=parseInt(j.value),x.stroke()):"freehand"===o&&u.length>0&&(x.beginPath(),x.moveTo(u[0].x,u[0].y),u.forEach((e=>x.lineTo(e.x,e.y))),x.fillStyle="rgba(0,0,255,0.2)",x.fill(),x.strokeStyle="blue",x.lineWidth=parseInt(j.value),x.stroke())}function L(e){if(e.length<3)return null;let t=e.map((e=>new jsts.geom.Coordinate(Math.round(10*e.x)/10,Math.round(10*e.y)/10)));t[0].x===t[t.length-1].x&&t[0].y===t[t.length-1].y||t.push(new jsts.geom.Coordinate(t[0].x,t[0].y));try{const e=n.createLinearRing(t);return n.createPolygon(e)}catch(e){return null}}function Q(e,t){try{const n=e.union(t),o=jsts.simplify.TopologyPreservingSimplifier.simplify(n,.1);return jsts.precision.GeometryPrecisionReducer.reduce(o,new jsts.geom.PrecisionModel(1e6))}catch(t){return e}}function W(e){let t=e;for(let e=r.length-1;e>=0;e--)if(t.intersects(r[e])||t.touches(r[e])){const n=Q(t,r[e]);n&&n.isValid()&&(t=n,r.splice(e,1))}return t}function aa(e,t){let n=1/0,o=-1;return y.forEach(((l,s)=>{const i=Math.hypot(l.x-e,l.y-t);i<n&&(n=i,o=s)})),{index:o,distance:n}}function ga(e,t){let n=1/0,o=null,l=-1,s=-1;for(let i=0;i<y.length;i++){const a=y[i],d=y[(i+1)%y.length],r=ma(e,t,a.x,a.y,d.x,d.y),c=Math.hypot(e-r.x,t-r.y);c<n&&(n=c,o=r,l=i,s=(i+1)%y.length)}return{point:o,distance:n,index1:l,index2:s}}function ma(e,t,n,o,l,s){const i=l-n,a=s-o,d=((e-n)*i+(t-o)*a)/(i*i+a*a);return{x:n+d*i,y:o+d*a}}function wa(e,t,n){Math.abs(e-n.x),Math.abs(t-n.y);return Math.abs(e-n.x)<=10&&Math.abs(t-n.y)<=10}function Aa(e,t){if(e.length<3)return e;let n=[e[0]];for(let o=1;o<e.length-1;o++){let l=e[o-1],s=e[o],i=e[o+1];n.push({x:s.x*(1-t)+t*(l.x+i.x)/2,y:s.y*(1-t)+t*(l.y+i.y)/2})}return n.push(e[e.length-1]),n}function Ha(){return{fillColor:`${h.value}${Math.round(2.55*k.value).toString(16).padStart(2,"0")}`,strokeColor:i.value,strokeWidth:parseInt(j.value)}}c.addEventListener("mousedown",(e=>{if("point"===o){const{offsetX:t,offsetY:n}=e;p.push(new jsts.geom.Coordinate(t,n)),K()}else if("freehand"===o)s=!0,u=[new jsts.geom.Coordinate(e.offsetX,e.offsetY)],K();else if(["edit","add","delete"].includes(o)){const{offsetX:t,offsetY:n}=e;if("edit"===o){const{index:e,distance:o}=aa(t,n);-1!==e&&(z=e,s=!0)}else if("add"===o){const{point:e,distance:o,index1:l,index2:i}=ga(t,n);o<=10&&(y.splice(l+1,0,e),z=l+1,s=!0)}else if("delete"===o){const{index:e,distance:o}=aa(t,n);-1!==e&&y.length>3&&y.splice(e,1)}K()}})),c.addEventListener("mousemove",(e=>{if("point"===o)q=new jsts.geom.Coordinate(e.offsetX,e.offsetY),K();else if("freehand"===o&&s)u.push(new jsts.geom.Coordinate(e.offsetX,e.offsetY)),K();else if("edit"===o&&s&&-1!==z)y[z].x=e.offsetX,y[z].y=e.offsetY,K();else if("add"===o){const{offsetX:t,offsetY:n}=e,{distance:o}=ga(t,n);c.style.cursor=o<=10?"crosshair":"default"}})),c.addEventListener("mouseup",(e=>{if("point"===o&&p.length>=3){const{offsetX:t,offsetY:n}=e;if(wa(t,n,p[0])||p.length>=10){p.push(new jsts.geom.Coordinate(p[0].x,p[0].y));const e=L(p);if(e&&e.isValid()){e.style=Ha();const t=W(e);t&&t.isValid()&&(r.push(t),p=[],q=null,K())}}}else if("freehand"===o){if(s=!1,u.length>=4){u.push(new jsts.geom.Coordinate(u[0].x,u[0].y));const e=parseInt(m.value)/100;u=Aa(u,e);const t=L(u);if(t&&t.isValid()){t.style=Ha();const e=W(t);e&&e.isValid()&&r.push(e)}u=[],K()}}else if(["edit","add","delete"].includes(o)&&(s=!1,-1!==z)){const e=L(y);e&&e.isValid()&&(e.style=r[w].style,r[w]=e),K(),z=-1}})),a.addEventListener("click",(()=>{o="point",A(a),p=[],q=null,u=[],w=-1,y=[],K()})),b.addEventListener("click",(()=>{o="freehand",A(b),p=[],q=null,u=[],w=-1,y=[],K()})),d.addEventListener("click",(()=>{o="edit",A(d),w=r.length-1,w>=0&&(y=r[w].getCoordinates().map((e=>({x:e.x,y:e.y})))),K()})),f.addEventListener("click",(()=>{o="add",A(f),w=r.length-1,w>=0&&(y=r[w].getCoordinates().map((e=>({x:e.x,y:e.y})))),K()})),g.addEventListener("click",(()=>{o="delete",A(g),w=r.length-1,w>=0&&(y=r[w].getCoordinates().map((e=>({x:e.x,y:e.y})))),K()})),e.addEventListener("click",(()=>{r=[],p=[],q=null,u=[],w=-1,y=[],z=-1,K()})),m.addEventListener("input",(()=>{v.textContent=m.value})),[h,i,j,k].forEach((e=>e.addEventListener("input",(()=>{l.textContent=k.value,K()})))),A(a),K()</script></body></html>