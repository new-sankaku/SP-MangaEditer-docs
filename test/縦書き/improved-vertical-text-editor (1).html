<!DOCTYPE html>
<html lang="ja">
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
      body {
        display: flex;
        margin: 0;
        padding: 0;
      }
      #canvasContainer {
        position: relative;
        display: inline-block;
      }
      #textArea {
        position: absolute;
        top: 0;
        right: 0;
        background-color: #fff;
        color: #000;
        caret-color: #000;
        font-family: "MS Mincho", "ＭＳ 明朝", serif;
        font-size: 20px;
        border: none;
        box-sizing: border-box;
        resize: none;
        overflow: hidden;
        writing-mode: vertical-rl;
        text-orientation: upright;
        letter-spacing: 0.1em;
        padding: 5px;
        display: none;
      }
      #controlPanel {
        margin: 10px;
      }
      #controlPanel label,
      #controlPanel input {
        margin-right: 5px;
      }
      .settingRow {
        display: flex;
        align-items: center;
        margin-bottom: 2px;
      }
      .settingRow label {
        width: 100px;
      }
      .settingRow input {
        width: 150px;
      }
      .settingRow span {
        width: 50px;
        text-align: right;
      }
    </style>
  </head>
  <body>
    <div>
      <div id="canvasContainer">
        <canvas id="canvas" width="500" height="500"></canvas>
        <textarea id="textArea"></textarea>
      </div>
      <div id="controlPanel">
        <button id="addTextButton">新しいテキストを追加</button>
        <div class="settingRow">
          <label for="fontSizeSlider">フォントサイズ:</label>
          <input
            type="range"
            id="fontSizeSlider"
            min="10"
            max="50"
            value="20"
          />
          <span id="fontSizeValue">20</span>
        </div>
        <div class="settingRow">
          <label for="lineHeightSlider">行間:</label>
          <input
            type="range"
            id="lineHeightSlider"
            min="0.5"
            max="2"
            step="0.1"
            value="1"
          />
          <span id="lineHeightValue">1</span>
        </div>
        <div class="settingRow">
          <label for="charSpacingSlider">文字間:</label>
          <input
            type="range"
            id="charSpacingSlider"
            min="0"
            max="0.5"
            step="0.05"
            value="0.1"
          />
          <span id="charSpacingValue">0.1</span>
        </div>
        <div class="settingRow">
          <label for="boldCheckbox">太字:</label>
          <input type="checkbox" id="boldCheckbox" />
        </div>
        <div class="settingRow">
          <label for="italicCheckbox">斜体:</label>
          <input type="checkbox" id="italicCheckbox" />
        </div>
        <div class="settingRow">
          <label for="fontFamilySelect">フォント:</label>
          <select id="fontFamilySelect">
            <option value="MS Mincho, ＭＳ 明朝, serif">ＭＳ 明朝</option>
            <option value="MS Gothic, ＭＳ ゴシック, sans-serif">
              ＭＳ ゴシック
            </option>
          </select>
        </div>
      </div>
    </div>
    <script>
      try {
        var canvas = new fabric.Canvas("canvas");
        var textArea = document.getElementById("textArea");
        var activeVerticalText = null;

        var VerticalText = fabric.util.createClass(fabric.Object, {
          type: "verticalText",
          text: "",
          fontSize: 20,
          fontFamily: "MS Mincho, ＭＳ 明朝, serif",
          fill: "black",
          padding: 5,
          charSpacing: 0.1,
          textAlign: "center",
          fontWeight: "normal",
          fontStyle: "normal",
          lineHeight: 1,
          textOffsetY: 3,
          initialize: function (text, options) {
            options = options || {};
            this.text = text || "";
            this.callSuper("initialize", options);
            this._updateDimensions();
          },
          _updateDimensions: function () {
            var ctx = this.canvas
              ? this.canvas.getContext("2d")
              : fabric.util.createCanvasElement().getContext("2d");
            ctx.font = this._getFontDeclaration();
            var lines = this.text.split("\n");
            var maxLineLength = Math.max.apply(
              Math,
              lines.map(function (line) {
                return line.length;
              })
            );
            var maxCharWidth = Math.max.apply(
              Math,
              this.text.split("").map(function (char) {
                return ctx.measureText(char).width;
              })
            );
            var textWidth =
              (maxCharWidth + 2 * this.padding) *
              lines.length *
              this.lineHeight;
            var textHeight =
              maxLineLength * this.fontSize * (1 + this.charSpacing) +
              2 * this.padding;
            var oldWidth = this.width;
            this.set({
              width: textWidth,
              height: textHeight,
              left: this.left - (textWidth - oldWidth),
            });
            this.setCoords();
          },
          _render: function (ctx) {
            ctx.save();
            ctx.scale(this.scaleX, this.scaleY);
            ctx.font = this._getFontDeclaration();
            ctx.fillStyle = this.fill;
            ctx.textAlign = this.textAlign;
            ctx.textBaseline = "middle";
            var lines = this.text.split("\n");
            var lineWidth =
              this.width / (lines.length * this.lineHeight * this.scaleX);
            lines.forEach(
              function (line, lineIndex) {
                var chars = line.split("");
                var lineX;
                switch (this.textAlign) {
                  case "right":
                    lineX =
                      this.width / (2 * this.scaleX) -
                      lineWidth * lineIndex * this.lineHeight;
                    break;
                  case "left":
                    lineX =
                      this.width / (2 * this.scaleX) -
                      lineWidth * (lineIndex + 1) * this.lineHeight;
                    break;
                  default:
                    lineX =
                      this.width / (2 * this.scaleX) -
                      lineWidth * (lineIndex + 0.5) * this.lineHeight;
                }
                var startY =
                  -this.height / (2 * this.scaleY) +
                  this.padding / this.scaleY +
                  this.fontSize / 2;
                chars.forEach(
                  function (char, charIndex) {
                    ctx.fillText(
                      char,
                      lineX,
                      startY +
                        charIndex * this.fontSize * (1 + this.charSpacing)
                    );
                  }.bind(this)
                );
              }.bind(this)
            );
            ctx.restore();
          },
          toObject: function () {
            return fabric.util.object.extend(this.callSuper("toObject"), {
              text: this.text,
              fontSize: this.fontSize,
              fontFamily: this.fontFamily,
              fontWeight: this.fontWeight,
              fontStyle: this.fontStyle,
              fill: this.fill,
              padding: this.padding,
              charSpacing: this.charSpacing,
              textAlign: this.textAlign,
              lineHeight: this.lineHeight,
              textOffsetY: this.textOffsetY,
            });
          },
          _getFontDeclaration: function () {
            return [
              this.fontStyle,
              this.fontWeight,
              this.fontSize + "px",
              this.fontFamily,
            ].join(" ");
          },
          _set: function (key, value) {
            this.callSuper("_set", key, value);
            if (
              key === "text" ||
              key === "fontSize" ||
              key === "fontFamily" ||
              key === "fontWeight" ||
              key === "fontStyle" ||
              key === "charSpacing" ||
              key === "textAlign" ||
              key === "lineHeight" ||
              key === "textOffsetY"
            ) {
              this._updateDimensions();
              this.set("dirty", true);
            }
            return this;
          },
        });

        fabric.VerticalText = VerticalText;
        fabric.VerticalText.fromObject = function (object, callback) {
          return fabric.Object._fromObject("VerticalText", object, callback);
        };

        function updateTextAreaPosition() {
          if (!activeVerticalText) return;
          var zoom = canvas.getZoom();
          var vpt = canvas.viewportTransform;
          var obj = activeVerticalText;
          var bounds = obj.getBoundingRect();
          var width, height, left, top;

          if (Math.abs(obj.angle) < 0.001) {
            var padding = {
              width: 0.08 * bounds.width,
              height: 0.08 * bounds.height,
            };
            width = bounds.width + padding.width;
            height = bounds.height + padding.height;
            left = bounds.left - padding.width;
            top = bounds.top + padding.height / 2;
          } else {
            width = 1.2 * obj.width * obj.scaleX;
            height = 1.2 * obj.height * obj.scaleY;
            var angle = (obj.angle * Math.PI) / 180;
            var cos = Math.cos(angle);
            var sin = Math.sin(angle);
            var centerX =
              obj.left +
              ((obj.width * obj.scaleX) / 2) * cos -
              ((obj.height * obj.scaleY) / 2) * sin;
            var centerY =
              obj.top +
              ((obj.width * obj.scaleX) / 2) * sin +
              ((obj.height * obj.scaleY) / 2) * cos;
            left = centerX - width / 2;
            top = centerY - height / 2;
          }

          textArea.style.left = left * zoom + vpt[4] + "px";
          textArea.style.top = top * zoom + vpt[5] + "px";
          textArea.style.width = width + "px";
          textArea.style.height = height + "px";
          textArea.style.fontSize = obj.fontSize * obj.scaleY + "px";
          textArea.style.letterSpacing = obj.charSpacing * obj.fontSize + "px";
          textArea.style.lineHeight = obj.lineHeight * 1.5;
          textArea.style.fontWeight = obj.fontWeight;
          textArea.style.fontStyle = obj.fontStyle;
          textArea.style.fontFamily = obj.fontFamily;
          textArea.style.paddingTop = obj.padding * 2.2 * obj.scaleY + "px";
          textArea.style.paddingRight = obj.padding * 2.2 * obj.scaleX + "px";
          textArea.style.transform = "scale(1, 1) rotate(0deg)";
          textArea.style.transformOrigin = "center center";
        }

        function updateVerticalText() {
          if (activeVerticalText) {
            var text = textArea.value.replace(/\r\n/g, "\n");
            activeVerticalText.set("text", text);
            activeVerticalText.set("dirty", true);
            activeVerticalText._updateDimensions();
            canvas.requestRenderAll();
            updateTextAreaPosition();
            canvas.fire("object:modified", { target: activeVerticalText });
          }
        }

        function showTextArea(obj) {
          activeVerticalText = obj;
          textArea.value = obj.text;
          textArea.style.display = "block";
          updateTextAreaPosition();
          setTimeout(function () {
            textArea.focus();
          }, 0);
        }

        function hideTextArea() {
          if (activeVerticalText) {
            updateVerticalText();
          }
          textArea.style.display = "none";
          activeVerticalText = null;
        }

        canvas.setBackgroundColor("#FFE6E6", canvas.renderAll.bind(canvas));

        var initialVerticalText = new VerticalText("縦書き\nテキスト", {
          left: 100,
          top: 100,
          fontSize: 20,
          fill: "black",
          lineHeight: 1,
          textOffsetY: 3,
        });

        function updateActiveObject(property, value) {
          var activeObject = canvas.getActiveObject();
          if (activeObject && activeObject instanceof VerticalText) {
            activeObject.set(property, value);
            activeObject._updateDimensions();
            canvas.requestRenderAll();
            updateTextAreaPosition();
          }
        }

        function getControlValues() {
          return {
            fontSize: parseInt(document.getElementById("fontSizeSlider").value),
            lineHeight: parseFloat(
              document.getElementById("lineHeightSlider").value
            ),
            charSpacing: parseFloat(
              document.getElementById("charSpacingSlider").value
            ),
            fontWeight: document.getElementById("boldCheckbox").checked
              ? "bold"
              : "normal",
            fontStyle: document.getElementById("italicCheckbox").checked
              ? "italic"
              : "normal",
            fontFamily: document.getElementById("fontFamilySelect").value,
          };
        }

        canvas.add(initialVerticalText);

        textArea.addEventListener("input", function () {
          updateVerticalText();
        });

        textArea.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            var start = this.selectionStart;
            var end = this.selectionEnd;
            this.value =
              this.value.slice(0, start) + "\n" + this.value.slice(end);
            this.selectionStart = this.selectionEnd = start + 1;
            updateVerticalText();
          }
        });

        textArea.onblur = hideTextArea;

        canvas.on("mouse:down", function (options) {
          if (options.target && options.target instanceof VerticalText) {
            canvas.setActiveObject(options.target);
            canvas.renderAll();
          } else {
            hideTextArea();
          }
        });
        canvas.on("mouse:dblclick", function (options) {
          if (options.target && options.target instanceof VerticalText) {
            showTextArea(options.target);
          }
        });

        document
          .getElementById("addTextButton")
          .addEventListener("click", function () {
            var controlValues = getControlValues();
            var newText = new VerticalText(
              "新しいテキスト",
              Object.assign(
                {
                  left: Math.random() * (canvas.width - 100),
                  top: Math.random() * (canvas.height - 100),
                  fill: "black",
                  textOffsetY: 3,
                },
                controlValues
              )
            );
            canvas.add(newText);
            canvas.setActiveObject(newText);
            canvas.requestRenderAll();
          });

        canvas.on("object:moving", updateTextAreaPosition);
        canvas.on("object:scaling", function (event) {
          var target = event.target;
          if (target instanceof VerticalText) {
            updateTextAreaPosition();
          }
        });

        canvas.on("object:modified", function (event) {
          var target = event.target;
          if (target instanceof VerticalText) {
            var left = target.left;
            var top = target.top;
            var width = target.width * target.scaleX;
            var height = target.height * target.scaleY;
            var newFontSize = target.fontSize * target.scaleY;
            var centerX = left + width / 2;
            var centerY = top + height / 2;
            target.set({
              scaleX: 1,
              scaleY: 1,
              fontSize: newFontSize,
              width: width,
              height: height,
            });
            target._updateDimensions();
            target.set({
              left: centerX - target.width / 2,
              top: centerY - target.height / 2,
            });
            canvas.requestRenderAll();
          }
        });

        canvas.on("object:rotating", updateTextAreaPosition);
        canvas.on("zoom:changed", updateTextAreaPosition);
        canvas.on("viewportTransform", updateTextAreaPosition);

        canvas.on("selection:created", function (event) {
          var selected = event.selected[0];
          if (selected instanceof VerticalText) {
            var fontSizeSlider = document.getElementById("fontSizeSlider");
            var fontSizeValue = document.getElementById("fontSizeValue");
            var lineHeightSlider = document.getElementById("lineHeightSlider");
            var lineHeightValue = document.getElementById("lineHeightValue");
            var charSpacingSlider =
              document.getElementById("charSpacingSlider");
            var charSpacingValue = document.getElementById("charSpacingValue");
            var boldCheckbox = document.getElementById("boldCheckbox");
            var italicCheckbox = document.getElementById("italicCheckbox");
            var fontFamilySelect = document.getElementById("fontFamilySelect");

            fontSizeSlider.value = selected.fontSize;
            fontSizeValue.textContent = selected.fontSize;
            lineHeightSlider.value = selected.lineHeight;
            lineHeightValue.textContent = selected.lineHeight;
            charSpacingSlider.value = selected.charSpacing;
            charSpacingValue.textContent = selected.charSpacing;
            boldCheckbox.checked = selected.fontWeight === "bold";
            italicCheckbox.checked = selected.fontStyle === "italic";
            fontFamilySelect.value = selected.fontFamily;

            updateTextAreaPosition();
          }
        });

        canvas.renderAll();

        ["fontSizeSlider", "lineHeightSlider", "charSpacingSlider"].forEach(
          function (id) {
            var slider = document.getElementById(id);
            var valueSpan = document.getElementById(id + "Value");
            slider.addEventListener("input", function () {
              if (valueSpan) {
                valueSpan.textContent = slider.value;
              }
              var property = {
                fontSizeSlider: "fontSize",
                lineHeightSlider: "lineHeight",
                charSpacingSlider: "charSpacing",
              }[id];
              updateActiveObject(property, parseFloat(slider.value));
            });
          }
        );

        document
          .getElementById("boldCheckbox")
          .addEventListener("change", function () {
            var fontWeight = this.checked ? "bold" : "normal";
            updateActiveObject("fontWeight", fontWeight);
          });

        document
          .getElementById("italicCheckbox")
          .addEventListener("change", function () {
            var fontStyle = this.checked ? "italic" : "normal";
            updateActiveObject("fontStyle", fontStyle);
          });

        document
          .getElementById("fontFamilySelect")
          .addEventListener("change", function () {
            var fontFamily = this.value;
            updateActiveObject("fontFamily", fontFamily);
          });
      } catch (error) {
        console.error("エラー発生:", error);
      }
    </script>
  </body>
</html>
