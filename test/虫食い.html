<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>エッジ検出と色選択可能な三角形の塗りつぶし/透明化</title><style>.control-panel{margin-top:10px}.control-item{margin-bottom:10px}.value-display{display:inline-block;width:40px;text-align:right}</style></head><body><input type="file" id="imageInput" accept="image/*"><canvas id="canvas"></canvas><div class="control-panel"><div class="control-item"><label for="widthSlider">線の幅 (ピクセル):</label> <input type="range" id="widthSlider" min="0" max="20" value="2" step="1"> <span id="widthValue" class="value-display">2</span></div><div class="control-item"><label for="probabilitySlider">適用確率 (%):</label> <input type="range" id="probabilitySlider" min="0" max="100" value="50" step="1"> <span id="probabilityValue" class="value-display">50</span></div><div class="control-item"><label for="colorPicker">色選択:</label> <input type="color" id="colorPicker" value="#FFC0CB"></div><div class="control-item"><label for="transparencyCheck">透明化:</label> <input type="checkbox" id="transparencyCheck"></div></div><script>const canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),imageInput=document.getElementById("imageInput"),widthSlider=document.getElementById("widthSlider"),widthValue=document.getElementById("widthValue"),probabilitySlider=document.getElementById("probabilitySlider"),probabilityValue=document.getElementById("probabilityValue"),colorPicker=document.getElementById("colorPicker"),transparencyCheck=document.getElementById("transparencyCheck");let originalImageData;function handleImage(t){const e=new FileReader;e.onload=function(t){const e=new Image;e.onload=function(){canvas.width=e.width,canvas.height=e.height,ctx.drawImage(e,0,0),originalImageData=ctx.getImageData(0,0,canvas.width,canvas.height),processImage()},e.src=t.target.result},e.readAsDataURL(t.target.files[0])}function handleControlChange(){widthValue.textContent=widthSlider.value,probabilityValue.textContent=probabilitySlider.value,originalImageData&&processImage()}function processImage(){const t=new ImageData(new Uint8ClampedArray(originalImageData.data),originalImageData.width,originalImageData.height),e=t.data,a=t.width,n=t.height,i=new Uint8ClampedArray(a*n),r=new Float32Array(a*n);for(let t=1;t<n-1;t++)for(let n=1;n<a-1;n++){const o=4*(t*a+n),l=-e[o-4-4*a]+e[o+4-4*a]+-2*e[o-4]+2*e[o+4]+-e[o-4+4*a]+e[o+4+4*a],d=-e[o-4*a-4]-2*e[o-4*a]-e[o-4*a+4]+e[o+4*a-4]+2*e[o+4*a]+e[o+4*a+4],h=Math.sqrt(l*l+d*d);i[t*a+n]=h>100?255:0,r[t*a+n]=Math.atan2(d,l)}const o=parseInt(widthSlider.value),l=parseInt(probabilitySlider.value)/100,d=hexToRgb(colorPicker.value),h=transparencyCheck.checked;for(let t=0;t<n;t++)for(let c=0;c<a;c++)if(255===i[t*a+c]&&Math.random()<l){const i=r[t*a+c],l=i+Math.PI/2,g=c,s=t,m=c+Math.cos(l)*o/2,u=t+Math.sin(l)*o/2,I=c-Math.cos(l)*o/2,p=t-Math.sin(l)*o/2,y=Math.random()*o+o/2,M=c+Math.cos(i)*y,f=t+Math.sin(i)*y,b=Math.max(0,Math.floor(Math.min(g,m,I,M))),w=Math.min(a-1,Math.ceil(Math.max(g,m,I,M))),C=Math.max(0,Math.floor(Math.min(s,u,p,f))),v=Math.min(n-1,Math.ceil(Math.max(s,u,p,f)));for(let t=C;t<=v;t++)for(let n=b;n<=w;n++)if(isPointInTriangle(n,t,g,s,m,u,M,f)||isPointInTriangle(n,t,g,s,I,p,M,f)){const i=4*(t*a+n);h?e[i+3]=0:(e[i]=d.r,e[i+1]=d.g,e[i+2]=d.b)}}ctx.putImageData(t,0,0)}function isPointInTriangle(t,e,a,n,i,r,o,l){const d=((r-l)*(t-o)+(o-i)*(e-l))/((r-l)*(a-o)+(o-i)*(n-l)),h=((l-n)*(t-o)+(a-o)*(e-l))/((r-l)*(a-o)+(o-i)*(n-l)),c=1-d-h;return 0<=d&&d<=1&&0<=h&&h<=1&&0<=c&&c<=1}function hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}imageInput.addEventListener("change",handleImage),widthSlider.addEventListener("input",handleControlChange),probabilitySlider.addEventListener("input",handleControlChange),colorPicker.addEventListener("input",handleControlChange),transparencyCheck.addEventListener("change",handleControlChange)</script></body></html>